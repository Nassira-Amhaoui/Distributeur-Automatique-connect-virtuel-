<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}Distributeur Automatique{% endblock %}</title>
    
    <!-- CSS Principal -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <!-- Feather Icons UNIQUEMENT (pas FontAwesome) -->
    <script src="https://unpkg.com/feather-icons"></script>
    
    {% block extra_css %}{% endblock %}
</head>

<body>

<div class="layout">

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo">
            <div class="logo-box">DA</div>
            <span>Distributeur<br>Automatique</span>
        </div>

        <nav class="menu">
            <a href="{{ url_for('dashboard') }}" class="{% if active=='dashboard' %}active{% endif %}">
                <i data-feather="home"></i> Dashboard
            </a>
            <a href="{{ url_for('produits') }}" class="{% if active=='produits' %}active{% endif %}">
                <i data-feather="package"></i> Produits
            </a>
            <a href="{{ url_for('product_history') }}" class="{% if active=='product_history' %}active{% endif %}">
                <i data-feather="pie-chart"></i> Analytics
            </a>
            <a href="{{ url_for('users') }}" class="{% if active=='users' %}active{% endif %}">
                <i data-feather="users"></i> Users
            </a>
            <a href="{{ url_for('settings') }}" class="{% if active=='settings' %}active{% endif %}">
                <i data-feather="settings"></i> Settings
            </a>
        </nav>

        <div class="user-box">
            <div class="avatar">AS</div>
            <div>
                <p class="name">Admin User</p>
                <p class="email">admin@example.com</p>
            </div>
        </div>
    </aside>

    <!-- Content area -->
    <main class="content">

        <!-- Top bar -->
        <header class="topbar">
            <div class="search">
                <i data-feather="search"></i>
                <input type="text" id="productSearch" placeholder="Search...">
            </div>

            <div class="top-icons">
                <!-- Notifications -->
                <div class="notification-wrapper" style="position: relative;" data-count="{{ produits_faible|length }}">
                    <i data-feather="bell" id="bell-icon"></i>
                    <span id="notif-badge" class="notif-badge"></span>

                    <div id="notification-panel" class="notification-panel">
                        <h3>Notifications</h3>
                        <ul>
                            {% if produits_faible %}
                                {% for p in produits_faible %}
                                    <li>‚ö†Ô∏è {{ p.Nom }} est presque √©puis√© ({{ p.Quantite }})</li>
                                {% endfor %}
                            {% else %}
                                <li>Aucune nouvelle notification.</li>
                            {% endif %}
                        </ul>
                    </div>
                </div>

                <!-- Toggle Light/Dark -->
                <label class="theme-toggle" id="themeToggle">
                    <input type="checkbox" id="themeCheckbox">
                    <span class="icon sun">‚òÄÔ∏è</span>
                    <span class="icon moon">üåô</span>
                    <span class="toggle-circle"></span>
                </label>

                <img src="https://ui-avatars.com/api/?name=Admin+User&background=6366f1&color=fff" class="admin-img" alt="Admin">
            </div>
        </header>

        <section class="page-content">
            {% block content %}{% endblock %}
        </section>
    </main>
</div>

<!-- Scripts √† la fin du body pour optimisation -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    // ========================================
    // INITIALISATION DES IC√îNES FEATHER
    // ========================================
    if (typeof feather !== 'undefined') {
        feather.replace();
    }

    // ========================================
    // GESTION DU MENU ACTIF
    // ========================================
    const menuItems = document.querySelectorAll('.menu a');
    menuItems.forEach(item => {
        item.addEventListener('click', function(e) {
            menuItems.forEach(i => i.classList.remove('selected'));
            this.classList.add('selected');
        });
    });

    // ========================================
    // GESTION DES NOTIFICATIONS
    // ========================================
    const bellWrapper = document.querySelector('.notification-wrapper');
    const notifPanel = document.getElementById("notification-panel");
    const notifBadge = document.getElementById("notif-badge");

    if (bellWrapper && notifPanel && notifBadge) {
        let count = parseInt(bellWrapper.dataset.count) || 0;

        // Afficher le badge si notifications
        if (count > 0) {
            notifBadge.textContent = count;
            notifBadge.style.display = "flex";
        } else {
            notifBadge.style.display = "none";
        }

        // Toggle du panel de notifications
        bellWrapper.addEventListener("click", function(e) {
            e.stopPropagation();
            notifPanel.classList.toggle("show");
            
            // Cacher le badge quand ouvert
            if (notifPanel.classList.contains("show")) {
                notifBadge.style.display = "none";
            }
        });

        // Fermer le panel en cliquant ailleurs
        document.addEventListener("click", function(e) {
            if (!notifPanel.contains(e.target) && !bellWrapper.contains(e.target)) {
                notifPanel.classList.remove("show");
            }
        });
    }

    // ========================================
    // THEME TOGGLE (DARK/LIGHT)
    // ========================================
    const themeCheckbox = document.getElementById("themeCheckbox");
    
    if (themeCheckbox) {
        // Charger le th√®me sauvegard√©
        try {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark');
                themeCheckbox.checked = true;
            }
        } catch (e) {
            console.log('localStorage non disponible, th√®me par d√©faut utilis√©');
        }

        // Toggle du th√®me
        themeCheckbox.addEventListener("change", function() {
            if (this.checked) {
                document.body.classList.add("dark");
                try {
                    localStorage.setItem('theme', 'dark');
                } catch (e) {
                    // Ignore si localStorage bloqu√©
                }
            } else {
                document.body.classList.remove("dark");
                try {
                    localStorage.setItem('theme', 'light');
                } catch (e) {
                    // Ignore si localStorage bloqu√©
                }
            }
        });
    }

    // ========================================
    // RECHERCHE DE PRODUITS
    // ========================================
    const searchInput = document.getElementById('productSearch');
    const table = document.querySelector('.products-table tbody');
    
    if (searchInput && table) {
        const rows = table.querySelectorAll('tr:not(.no-match)');
        
        searchInput.addEventListener('input', function() {
            const filter = this.value.toLowerCase();
            let hasVisible = false;

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                let match = false;
                
                cells.forEach(cell => {
                    if (cell.textContent.toLowerCase().includes(filter)) {
                        match = true;
                    }
                });
                
                row.style.display = match ? '' : 'none';
                if (match) hasVisible = true;
            });

            // Gestion du message "Aucun r√©sultat"
            let emptyRow = table.querySelector('.no-match');
            
            if (!hasVisible && filter !== '') {
                if (!emptyRow) {
                    const tr = document.createElement('tr');
                    tr.classList.add('no-match');
                    tr.innerHTML = `<td colspan="4" style="text-align:center; padding:20px;">Aucun produit trouv√©.</td>`;
                    table.appendChild(tr);
                }
            } else {
                if (emptyRow) emptyRow.remove();
            }
        });
    }

    console.log('Application initialis√©e avec succ√®s');
});
</script>

{% block extra_js %}{% endblock %}

</body>
</html>